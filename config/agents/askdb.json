{
  "class": "CustomAgent",
  "description": "agent to ask questions to postgres db directly.",
  "model_type": "bedrock",
  "model_name": "anthropic.claude-3-7-sonnet-20250219-v1:0",
  "system_prompt": [
    "You are AskDB, an intelligent agent with access to PostgreSQL database queries and specialized database agents.",
    "Your role is to answer user questions about the database in clear, natural language.",
    "",
    "Specialized Agents Available:",
    "- UserProfileAgent: User accounts, profiles, activity, self-exclusion settings",
    "- WalletAgent: Financial transactions, wallet operations, account transfers",
    "- BonusAgent: Bonus policies, awards, redemptions, turnover requirements", 
    "- BettingAgent: Sports betting, customer orders, market exposures, sports books",
    "- CasinoAgent: Casino games, providers, categories",
    "- AffiliateAgent: Affiliate relationships, campaigns, commissions",
    "- ProfitLossAgent: Profit/loss metrics, daily house P&L, exposure logs",
    "- ConfigurationAgent: System configurations, whitelabel settings",
    "- NotificationAgent: System notifications, user communications",
    "- EventTrackingAgent: Domain events, system changes, database modifications",
    "",
    "These specialised agents have lot of details about schema of tables and how they are related to each other.",
    "You can ask schema from those agent, if required.",
    "",
    "Agent Selection Strategy:",
    "- ALWAYS prioritize using specialized agents over direct postgres_query as they have more context",
    "  and are fine-tuned for their specific table domains",
    "- Use specialized agents whenever the query relates to their domain expertise, even partially", 
    "- You can use multiple specialized agents in parallel for complex queries spanning multiple domains",
    "- Only use direct postgres_query when:",
    "  * The query requires tables or data that span beyond any single agent's expertise",
    "  * You need to perform complex joins across multiple domains that specialized agents cannot handle",
    "  * The query involves tables not covered by any specialized agent",
    "- When in doubt, prefer delegating to the most relevant specialized agent rather than executing SQL directly",
    "",
    "Additional Instructions:",
    "- When a user request requires multiple tool executions (e.g., multiple independent queries or lookups),",
    "  dispatch these tool calls in parallel whenever possible to minimize response time",
    "- Aggregate and summarize the results from all parallel tool calls before responding to the user",
    "- If any tool call fails, report the error clearly but still return results from successful tool calls",
    "- Only execute tool calls in parallel if they are independent and do not depend on each other's results",
    "",
    "Instructions:",
    "- Only allow and execute read-only queries (e.g., SELECT). Do NOT allow or execute any queries that",
    "  edit, delete, or modify the database (such as UPDATE, DELETE, INSERT, ALTER, DROP, etc.)",
    "- Never fetch or return the entire database or very large datasets in a single response.",
    "  If a query could return a large amount of data, use intelligent pagination and inform the user",
    "  about the data size and how to request more if needed",
    "- Always prioritize concise, relevant answers. Summarize or aggregate results when possible",
    "  to avoid context overflow",
    "- If a user requests a restricted action (edit, delete, modify), politely refuse and explain",
    "  that only read-only access is permitted",
    "- When answering, provide clear explanations in natural language. Do NOT show SQL queries",
    "  unless the user explicitly asks for them (e.g., 'show SQL' or 'give me the query')",
    "- Do not ask users for query confirmation. Always infer the required details and generate",
    "  the answer directly",
    "- Provide answers in clear, natural language unless the user explicitly requests otherwise",
    "",
    "Your goal is to help users explore and understand the database.",
    "Your responses should help users explore and understand the database, while strictly following the above rules.",
    "You can explicitly say no to queries asking for things other than data exploration."
  ],
  "tools": [
    "postgres_query",
    "append_memory",
    "UserProfileAgent",
    "WalletAgent",
    "BonusAgent",
    "BettingAgent",
    "CasinoAgent",
    "AffiliateAgent",
    "ProfitLossAgent",
    "ConfigurationAgent",
    "NotificationAgent",
    "EventTrackingAgent"
  ],
  "parallel_tools": true,
  "max_parallel_tools": 3,
  "memory": [

  "[2025-08-19 17:33:10] Database Structure Information:",
  "",
  "",
  "1. BONUS TABLE:",
  "- Primary key: id (bigint)",
  "- Key columns: account_id, bonus_policy_id, bonus_type, bonus_status, award_amount, redeem_amount, turnover_required",
  "- Contains information about individual bonus awards given to users",
  "- bonus_type values: DEPOSIT_BONUS, JOINING_BONUS, LOSSBACK_BONUS, REFERRAL_BONUS, SIGNUP_BONUS, SPECIAL_BONUS",
  "- bonus_status values: AWARDED, AWARD_IN_PROGRESS, CANCELLED, EXPIRED, REDEEMED",
  "- award_freq values: DAILY, NULL",
  "- Tracks turnover requirements with columns: turnover_required, turnover_met, turnover_snapshot",
  "- Related to bonus_policy table via bonus_policy_id column",
  "- award_date: Column name which stores \"timestamp with time zone\"",
  "- award_amount: Column name for bonus amounts",
  "",
  "2. BONUS_POLICY TABLE:",
  "- Primary key: id (bigint)",
  "- Key columns: bonus_category, bonus_purpose, name, start_date, end_date, is_active, max_users, limit_per_user",
  "- Contains configurations for different bonus policies/campaigns",
  "- bonus_category values: DEPOSIT_BONUS, LOSSBACK_BONUS, REFERRAL_BONUS, SIGNUP_BONUS, JOINING_BONUS, SPECIAL_BONUS",
  "- bonus_purpose values: ACQUISITION, RETENTION",
  "- Policies have time constraints with start_date and end_date",
  "- Can limit usage with max_users and limit_per_user",
  "",
  "3. CUSTOMER_ORDER TABLE:",
  "- Primary key: order_id (bigint)",
  "- Key columns: account_id, username, placed_time, status, placed_stake, matched_stake, returns",
  "- Contains betting orders/transactions",
  "- Has detailed event information: sport_id, competition_id, event_id, market_id, outcome_id",
  "- Includes financial details: placed_stake, matched_stake, cancelled_stake, returns, bonus_redeemed",
  "- Tracks odds with: placed_odd, matched_odd, odd_before, odd_after",
  "",
  "4. TURNOVER_ENTRY TABLE:",
  "- Primary key: id (bigint)",
  "- Key columns: account_id, username, amount, transaction_type, turnover_after",
  "- Tracks turnover progress for users",
  "- transaction_type values: GAP_BET_ROLLBACK, GAP_BET_SETTLEMENT, SAP_BET_ROLLBACK, SAP_BET_SETTLEMENT, SAP_BET_VOID, SPORT_BOOK_BET_ROLLBACK, SPORT_BOOK_BET_SETTLEMENT, VOID_BET_SETTLEMENT",
  "- Related to bonus table via account_id (users need to meet turnover requirements to redeem bonuses)",
  "",
  "5. KPI_ENTITY TABLE:",
  "- Primary key: id (bigint)",
  "- Key columns: category, sub_category, value, account_id, username",
  "- Tracks various KPIs for accounts",
  "- category values: REFUND, WITHDRAW, DEPOSIT, SIGNUP",
  "- sub_category values: OTHERS, FIRST_DEPOSIT",
  "",
  "Relationships:",
  "- bonus.bonus_policy_id relates to bonus_policy.id",
  "- bonus.account_id relates to turnover_entry.account_id (for tracking turnover requirements)",
  "- Both bonus and turnover_entry tables have username and account_id columns that can be used to join them",
  "- customer_order may relate to turnover_entry via account_id and username for tracking betting activity",
  "",
  "This database appears to be for a betting/gaming platform that manages various types of bonuses, tracks user betting activity, monitors turnover requirements for bonus redemption, and measures KPIs.",
  "",
  "[2025-08-19 17:34:35] KPI Entity Table (kpi_entity) Detailed Documentation:",
  "- Purpose: Tracks KPI events for accounts across different sportsbook white-labels",
  "- Key categories: DEPOSIT, WITHDRAW, SIGNUP, REFUND",
  "- Sub-categories: FIRST_DEPOSIT (special tracking for first deposits), OTHERS",
  "- Important columns:",
  "  * reference_id: Links to transaction or account records",
  "  * sports_book: Links to white-label sportsbook brands",
  "  * create_time: Critical for time-based analytics",
  "  * value: Monetary value for transactions (important for WITHDRAW and REFUND)",
  "- Usage notes:",
  "  * FIRST_DEPOSIT is specifically used for first deposit bonuses and onboarding metrics",
  "  * SIGNUP KPIs typically have zero value with account ID in reference_id",
  "",
  "Turnover Entry Table (turnover_entry) Detailed Documentation:",
  "- Purpose: System of record for wagering volume used by reporting, VIP, and bonus redemption",
  "- Records user turnover at bet/market settlement across different categories",
  "- OrderCategory enum: SPORTS, PREMIUM, SPORTS_BOOK, CASINO",
  "- Critical for bonus progression tracking",
  "- Process flow for turnover to bonus:",
  "  1. When a bet settles, a turnover entry is created",
  "  2. System selects eligible bonuses (FIFO by award time)",
  "  3. Applies turnover to a single bonus at a time",
  "  4. When turnover_met reaches turnover_required, bonus is REDEEMED",
  "  5. Any remainder may be applied to next eligible bonus (implementation-specific)",
  "- Turnover definition varies by category:",
  "  * Casino/Premium: stake amount of settled bets",
  "  * Sports/Sportsbook: net market risk at market-level settlement",
  "- For bonus redemption: required_turnover = award_amount × multiplier",
  "",
  "Relationship between kpi_entity and turnover_entry:",
  "- Both capture per-user activity at different layers",
  "- Can be joined by account_id (preferred) or account_path",
  "- account_path can be used for hierarchy rollups (agent/SDM/upline)",
  "- Tenant scoping considerations: sports_book vs house_id",
  "- One user has many KPI events and turnover entries (many-to-many via user)",
  "",
  "[2025-08-19 17:34:44] Bonus Redemption Process:",
  "1. Bonuses start in AWARDED status with turnover_met at 0",
  "2. As user places and settles bets, turnover_entry records are created",
  "3. Turnover is applied to bonuses in FIFO order (oldest first)",
  "4. When turnover_met reaches turnover_required, the bonus status changes to REDEEMED",
  "5. Upon redemption, funds transfer from bonus balance to main balance",
  "6. Redemption must occur before bonus expiry",
  "",
  "Example Bonus Progression:",
  "- Bonus A: turnover_required = 500, turnover_met = 400, status AWARDED",
  "- Bonus B: turnover_required = 1000, turnover_met = 0, status AWARDED",
  "- When a 100 INR bet settles:",
  "  * New turnover_entry with amount = 100",
  "  * Applied to Bonus A (FIFO rule)",
  "  * Bonus A turnover_met becomes 500",
  "  * Bonus A transitions to REDEEMED",
  "  * Funds move to main wallet",
  "  * Bonus B remains unchanged until next settlement",
  "",
  "Turnover entries are critical for:",
  "- Bonus redemption tracking",
  "- Wagering volume analytics",
  "- VIP program qualification",
  "- Regulatory reporting",
  "",
  "[2025-08-19 17:37:00] Customer Order Table - Detailed Information",
  "",
  "1. Profit Calculation Formula:",
  "   - Profit = SUM(matched_stake - returns)",
  "   - Positive value indicates house profit, negative means player profit",
  "   - Only settled bets should be used for profit/loss calculation",
  "",
  "2. Customer Order Categories:",
  "",
  "   a) Casino Category:",
  "   - category_type: 4",
  "   - sport_name: CASINO",
  "   - sport_id: Same as event_id (represents game ID of the casino game)",
  "   - competition_id: Provider of the casino game",
  "   - competition_name: Sub-provider name",
  "   - event_id: Same as sport_id",
  "   - event_name: Casino game name",
  "   - market_id: Round ID of the casino game",
  "   - market_type: 4 (CASINO)",
  "   - providerCorrelationId: Present (bet ID at provider)",
  "",
  "   b) Sports Category:",
  "   - category_type: 0",
  "   - sport_name: Lowercase sport name",
  "   - sport_id: Mapped via sports mapping table (e.g., cricket → 4, soccer → 1)",
  "   - competition_id/competition_name: League or tournament info",
  "   - event_id/event_name: Match details",
  "   - market_id/market_name: Market within the event (e.g., Match Odds)",
  "   - market_type: 0 (MATCH_ODDS)",
  "   - providerCorrelationId: Usually empty for sports",
  "",
  "   c) Premium Category:",
  "   - category_type: 1",
  "   - sport_name: Sportradar style ID (e.g., sr:sport:21) mapped to readable sport name",
  "   - sport_id: Sportradar sport ID",
  "   - competition_id/competition_name: Tournament name",
  "   - event_id/event_name: Match details",
  "   - market_id/market_name: Custom market description",
  "   - market_type: 3 (PREMIUM)",
  "   - providerCorrelationId: Present (bet ID at provider)",
  "",
  "   d) Sportsbook Category:",
  "   - category_type: 2",
  "   - sport_name: Readable sport name (e.g., Cricket)",
  "   - sport_id: Sportradar style ID (e.g., sr:sport:21)",
  "   - competition_id/competition_name: Virtual or real sports competition",
  "   - event_id/event_name: Match details",
  "   - market_id/market_name: Market details",
  "   - market_type: 3 (PREMIUM) — match odds format",
  "   - providerCorrelationId: Present (bet ID at provider)",
  "",
  "3. Key Mapping Rules:",
  "   - sport_id mapping:",
  "     * Casino: same as event_id",
  "     * Sports: from lowercase sport name via sports mapping table",
  "     * Premium/Sportsbook: Sportradar style (sr:sport:X) mapped to readable name",
  "   - market_type:",
  "     * 0 → MATCH_ODDS (sports only)",
  "     * 3 → PREMIUM (premium + sportsbook)",
  "     * 4 → CASINO (casino only)",
  "   - providerCorrelationId:",
  "     * Present for Casino, Premium, Sportsbook",
  "     * Usually empty for Sports",
  "",
  "4. Common Analysis Queries:",
  "   a) Turnover and profit by sports/category/event:",
  "      - For turnover: Use turnover_entry table, group by category/sports/event",
  "      - For profit: Use customer_order table, calculate profit as matched_stake - returns",
  "",
  "   b) Profit for a specific casino game in last 24 hours:",
  "      - Filter by category_type = 4 (Casino)",
  "      - Filter by event_id for specific game",
  "      - Filter by update_time for last 24 hours",
  "      - Calculate profit = matched_stake - returns",
  "      - Only include settled bets (check status)",
  "",
  "   c) User count for a specific game:",
  "      - Filter by event_id",
  "      - Count distinct account_id",
  "",
  "   d) Most played game in last 24 hours:",
  "      - Group by event_id and event_name",
  "      - Count distinct account_id",
  "      - Order by count descending",
  "",
  "   e) Top sports summary:",
  "      - Group by sport",
  "      - Show top 5 events by profit/loss",
  "      - Show top 5 games by profit/loss",
  "",
  "   f) First-time deposit vs recurring deposit analysis:",
  "      - Use KPI entity table",
  "      - For FTD: Filter by category=DEPOSIT, subcategory=FIRST_DEPOSIT",
  "      - For recurring: Filter by category=DEPOSIT, subcategory=OTHERS",
  "",
  "[2025-08-19 17:41:29] To answer \"how many people signed up this month\" questions:",
  "1. The user signup information is stored in the user_profile table",
  "2. The user_profile table has a create_time field that indicates when users signed up",
  "3. To get monthly signups, use a query like: SELECT COUNT(*) FROM user_profile WHERE create_time >= DATE_TRUNC('month', CURRENT_DATE) AND create_time < DATE_TRUNC('month', CURRENT_DATE) + INTERVAL '1 month'",
  "4. This query counts all records where create_time is within the current month",
  "5. For questions about user signups or registrations, always check the user_profile table first",
  "",
  "[2025-08-22 23:26:55] After analyzing the database structure, I've found that there isn't a direct table relationship between events and bonuses. Bonuses are managed through the bonus and bonus_policy tables, while events are part of the customer_order table. The connection happens when users redeem bonuses while placing bets on specific events, which is tracked through the bonus_redeemed column in the customer_order table."
]
}